# 第 1 章 异步：现在与将来

事实上，程序中现在运行的部分和将来运行的部分之间的关系就是`异步编程的核心`。

## 1.1 分块的程序

举例来说，考虑一下下面这段代码：

```js
function now() {
    return 21;
}

function later() {
    answer = answer ＊ 2;
    console.log( "Meaning of life:", answer );
}

var answer = now();

setTimeout( later, 1000 ); // Meaning of life: 42
```

这个程序有两个块：现在执行的部分，以及将来执行的部分。这两块的内容很明显，但这里我们还是要明确指出来。

现在

```js
function now() {
    return 21;
}

function later() { .. }

var answer = now();

setTimeout( later, 1000 );
```

将来

```js
answer = answer ＊ 2;
console.log( "Meaning of life:", answer );
```

任何时候，只要把一段代码包装成一个函数，并指定它在响应某个事件（定时器、鼠标点击、Ajax 响应等）时执行，你就是在代码中创建了一个将来执行的块，`也由此在这个程序中引入了异步机制`。

1. 异步控制台

## 1.2 事件循环

尽管你显然能够编写异步 JavaScript 代码（就像前面我们看到的定时代码）​，但`直到最近（ES6）, JavaScript 才真正内建有直接的异步概念`。

JavaScript 引擎并不是独立运行的，它运行在宿主环境中，对多数开发者来说通常就是 Web 浏览器。经过最近几年（不仅于此）的发展，JavaScript 已经超出了浏览器的范围，进入了其他环境，比如通过像 Node.js 这样的工具进入服务器领域。实际上，JavaScript 现如今已经嵌入到了从机器人到电灯泡等各种各样的设备中。

那么，什么是事件循环？先通过一段伪代码了解一下这个概念：

```js
// eventLoop是一个用作队列的数组
//（先进，先出）
var eventLoop = [];
var event;

// “永远”执行
while (true) {
  // 一次tick
  if (eventLoop.length > 0) {
    // 拿到队列中的下一个事件
    event = eventLoop.shift();

    // 现在，执行下一个事件
    try {
      event();
    } catch (err) {
      reportError(err);
    }
  }
}
```

你可以看到，有一个用 while 循环实现的持续运行的循环，循环的每一轮称为一个 tick。对每个 tick 而言，如果在队列中有等待事件，那么就会从队列中摘下一个事件并执行。这些事件就是你的回调函数。

一定要清楚，setTimeout(..)并没有把你的回调函数挂在事件循环队列中。它所做的是设定一个定时器。当定时器到时后，环境会把你的回调函数放在事件循环中，这样，在未来某个时刻的 tick 会摘下并执行这个回调。

## 1.3 并行线程

术语“异步”和“并行”常常被混为一谈，但实际上它们的意义完全不同。记住，`异步是关于现在和将来的时间间隙，而并行是关于能够同时发生的事情`。

并行计算最常见的工具就是进程和线程。进程和线程独立运行，并可能同时运行：在不同的处理器，甚至不同的计算机上，但多个线程能够共享单个进程的内存。

## 1.4 并发

### 1.4.1 非交互

两个或多个“进程”在同一个程序内并发地交替运行它们的步骤/事件时，如果这些任务彼此不相关，就不一定需要交互。如果进程间没有相互影响的话，不确定性是完全可以接受的。

```js
var res = {};

function foo(results) {
  res.foo = results;
}

function bar(results) {
  res.bar = results;
}

// ajax(..)是某个库提供的某个Ajax函数
ajax("http://some.url.1", foo);
ajax("http://some.url.2", bar);
```

foo()和 bar()是两个并发执行的“进程”​，按照什么顺序执行是不确定的。但是，我们构建程序的方式使得无论按哪种顺序执行都无所谓，因为它们是独立运行的，不会相互影响。

### 1.4.2 交互

更常见的情况是，并发的“进程”需要相互交流，通过作用域或 DOM 间接交互。正如前面介绍的，如果出现这样的交互，就需要对它们的交互进行协调以避免竞态的出现。

### 1.4.3 协作

## 1.5 任务

在 ES6 中，有一个新的概念建立在事件循环队列之上，叫作任务队列（job queue）​。这个概念给大家带来的最大影响可能是 Promise 的异步特性（参见第 3 章）​。

## 1.6 语句顺序

## 1.7 小结

实际上，JavaScript 程序总是至少分为两个块：第一块现在运行；下一块将来运行，以响应某个事件。尽管程序是一块一块执行的，但是所有这些块共享对程序作用域和状态的访问，所以对状态的修改都是在之前累积的修改之上进行的。

一旦有事件需要运行，事件循环就会运行，直到队列清空。事件循环的每一轮称为一个 tick。用户交互、IO 和定时器会向事件队列中加入事件。

`任意时刻，一次只能从队列中处理一个事件`。执行事件的时候，可能直接或间接地引发一个或多个后续事件。

`并发是指两个或多个事件链随时间发展交替执行`，以至于从更高的层次来看，就像是同时在运行（尽管在任意时刻只处理一个事件）​。

通常需要对这些并发执行的“进程”​（有别于操作系统中的进程概念）进行某种形式的交互协调，比如需要确保执行顺序或者需要防止竞态出现。这些“进程”也可以通过把自身分割为更小的块，以便其他“进程”插入进来。
